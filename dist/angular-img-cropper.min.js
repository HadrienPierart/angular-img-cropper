/*! angular-img-cropper 15-05-2015 */
angular.module("angular-img-cropper",[]).directive("imageCropper",["$document","$window",function(){return{scope:{image:"=",croppedImage:"=",cropWidth:"=",cropHeight:"=",keepAspect:"=",touchRadius:"="},restrict:"A",link:function(t,i){var e,s=s||function(t,i){function e(){this.constructor=t}for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s]);e.prototype=i.prototype,t.prototype=new e},o=function(){function t(t,i,e){this.over=!1,this.drag=!1,this.position=new g(t,i),this.offset=new g(0,0),this.radius=e}return t.prototype.setDrag=function(t){this.drag=t,this.setOver(t)},t.prototype.draw=function(){},t.prototype.setOver=function(t){this.over=t},t.prototype.touchInBounds=function(t,i){return t>this.position.x-this.radius&&this.position.x+this.radius>t&&i>this.position.y-this.radius&&this.position.y+this.radius>i},t.prototype.getPosition=function(){return this.position},t.prototype.setPosition=function(t,i){this.position.x=t,this.position.y=i},t}(),n=function(){function t(i){this.borrowed=0,t.instance=this;for(var e=null,s=0;i>s;s++)if(0===s)this.firstAvailable=new g,e=this.firstAvailable;else{var o=new g;e.setNext(o),e=o}}return t.prototype.borrow=function(t,i){if(null==this.firstAvailable)throw"Pool exhausted";this.borrowed++;var e=this.firstAvailable;return this.firstAvailable=e.getNext(),e.x=t,e.y=i,e},t.prototype.returnPoint=function(t){this.borrowed--,t.x=0,t.y=0,t.setNext(this.firstAvailable),this.firstAvailable=t},t}(),r=function(){function t(){}return t.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},t.DEG2RAD=.0174532925,t}(),h=function(t){function i(i,e,s){t.call(this,i,e,s),this.iconPoints=[],this.scaledIconPoints=[],this.getDragIconPoints(this.iconPoints,1),this.getDragIconPoints(this.scaledIconPoints,1.2)}return s(i,t),i.prototype.draw=function(t){this.over||this.drag?this.drawIcon(t,this.scaledIconPoints):this.drawIcon(t,this.iconPoints)},i.prototype.getDragIconPoints=function(t,i){var e=17*i,s=14*i,o=8*i,r=4*i;t.push(n.instance.borrow(-r/2,e-o)),t.push(n.instance.borrow(-s/2,e-o)),t.push(n.instance.borrow(0,e)),t.push(n.instance.borrow(s/2,e-o)),t.push(n.instance.borrow(r/2,e-o)),t.push(n.instance.borrow(r/2,r/2)),t.push(n.instance.borrow(e-o,r/2)),t.push(n.instance.borrow(e-o,s/2)),t.push(n.instance.borrow(e,0)),t.push(n.instance.borrow(e-o,-s/2)),t.push(n.instance.borrow(e-o,-r/2)),t.push(n.instance.borrow(r/2,-r/2)),t.push(n.instance.borrow(r/2,-e+o)),t.push(n.instance.borrow(s/2,-e+o)),t.push(n.instance.borrow(0,-e)),t.push(n.instance.borrow(-s/2,-e+o)),t.push(n.instance.borrow(-r/2,-e+o)),t.push(n.instance.borrow(-r/2,-r/2)),t.push(n.instance.borrow(-e+o,-r/2)),t.push(n.instance.borrow(-e+o,-s/2)),t.push(n.instance.borrow(-e,0)),t.push(n.instance.borrow(-e+o,s/2)),t.push(n.instance.borrow(-e+o,r/2)),t.push(n.instance.borrow(-r/2,r/2))},i.prototype.drawIcon=function(t,i){t.beginPath(),t.moveTo(i[0].x+this.position.x,i[0].y+this.position.y);for(var e=0;i.length>e;e++){var s=i[e];t.lineTo(s.x+this.position.x,s.y+this.position.y)}t.closePath(),t.fillStyle="rgba(255,228,0,1)",t.fill()},i.prototype.recalculatePosition=function(t){var i=t.getCentre();this.setPosition(i.x,i.y),n.instance.returnPoint(i)},i}(o),a=function(t){function i(i,e,s){t.call(this,i,e,s)}return s(i,t),i.prototype.drawCornerBorder=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,s=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(s=-1),t.beginPath(),t.lineJoin="miter",t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*s),t.lineTo(this.position.x,this.position.y+i*s),t.lineTo(this.position.x,this.position.y),t.closePath(),t.lineWidth=2,t.strokeStyle="rgba(255,228,0,1)",t.stroke()},i.prototype.drawCornerFill=function(t){var i=10;(this.over||this.drag)&&(i=12);var e=1,s=1;this.horizontalNeighbour.position.x<this.position.x&&(e=-1),this.verticalNeighbour.position.y<this.position.y&&(s=-1),t.beginPath(),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+i*e,this.position.y),t.lineTo(this.position.x+i*e,this.position.y+i*s),t.lineTo(this.position.x,this.position.y+i*s),t.lineTo(this.position.x,this.position.y),t.closePath(),t.fillStyle="rgba(0,0,0,1)",t.fill()},i.prototype.moveX=function(t){this.setPosition(t,this.position.y)},i.prototype.moveY=function(t){this.setPosition(this.position.x,t)},i.prototype.move=function(t,i){this.setPosition(t,i),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(i)},i.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},i.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},i.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},i.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},i.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},i}(o),c=function(){function t(t,i,e,s){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=0),this.left=t,this.right=t+e,this.top=i,this.bottom=i+s}return t.prototype.getWidth=function(){return this.right-this.left},t.prototype.getHeight=function(){return this.bottom-this.top},t.prototype.getCentre=function(){var t=this.getWidth(),i=this.getHeight();return n.instance.borrow(this.left+t/2,this.top+i/2)},t}(),g=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t.prototype.setNext=function(t){this.next=t},t.prototype.getNext=function(){return this.next},t}(),u=function(){function t(t,i,e){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),this.id=0,this.x=t,this.y=i,this.id=e}return t}(),p=function(){function i(t,i,e,s,o,c,g){void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=100),void 0===o&&(o=50),void 0===c&&(c=!0),void 0===g&&(g=20),this.keepAspect=!1,this.aspectRatio=0,this.currentDragTouches=[],this.isMouseDown=!1,this.ratioW=1,this.ratioH=1,this.fileType="png",this.imageSet=!1,this.pointPool=new n(200),r.init(t),this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas"),this.buffer.width=t.width,this.buffer.height=t.height,this.tl=new a(i,e,g),this.tr=new a(i+s,e,g),this.bl=new a(i,e+o,g),this.br=new a(i+s,e+o,g),this.tl.addHorizontalNeighbour(this.tr),this.tl.addVerticalNeighbour(this.bl),this.tr.addHorizontalNeighbour(this.tl),this.tr.addVerticalNeighbour(this.br),this.bl.addHorizontalNeighbour(this.br),this.bl.addVerticalNeighbour(this.tl),this.br.addHorizontalNeighbour(this.bl),this.br.addVerticalNeighbour(this.tr),this.markers=[this.tl,this.tr,this.bl,this.br],this.center=new h(i+s/2,e+o/2,g),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.keepAspect=c,this.aspectRatio=o/s,this.draw(this.ctx),this.croppedImage=new Image,window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("mousedown",this.onMouseDown.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this),!1),t.addEventListener("touchstart",this.onTouchStart.bind(this),!1),window.addEventListener("touchend",this.onTouchEnd.bind(this),!1)}return i.prototype.resizeCanvas=function(t,i){this.canvas.width=t,this.canvas.height=i,this.buffer.width=t,this.buffer.height=i,this.draw(this.ctx)},i.prototype.draw=function(t){var i=this.getBounds();if(this.srcImage){t.clearRect(0,0,this.canvasWidth,this.canvasHeight);var e=this.srcImage.height/this.srcImage.width,s=this.canvasHeight/this.canvasWidth,o=this.canvasWidth,n=this.canvasHeight;s>e?(o=this.canvasWidth,n=this.canvasWidth*e):(n=this.canvasHeight,o=this.canvasHeight/e),this.ratioW=o/this.srcImage.width,this.ratioH=n/this.srcImage.height,e>s?this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-o/2,0,o,n):this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-n/2,o,n),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.drawImage(this.buffer,i.left,i.top,Math.max(i.getWidth(),1),Math.max(i.getHeight(),1),i.left,i.top,i.getWidth(),i.getHeight());for(var r,h=0;this.markers.length>h;h++)r=this.markers[h],r.draw(t);this.center.draw(t),t.lineWidth=2,t.strokeStyle="rgba(255,228,0,1)",t.strokeRect(i.left,i.top,i.getWidth(),i.getHeight())}else t.fillStyle="rgba(192,192,192,1)",t.fillRect(0,0,this.canvas.width,this.canvas.height)},i.prototype.dragCrop=function(t,i,e){var s=this.getBounds(),o=t-s.getWidth()/2,n=t+s.getWidth()/2,r=i-s.getHeight()/2,h=i+s.getHeight()/2;n>=this.maxXClamp&&(t=this.maxXClamp-s.getWidth()/2),this.minXClamp>=o&&(t=s.getWidth()/2+this.minXClamp),this.minYClamp>r&&(i=s.getHeight()/2+this.minYClamp),h>=this.maxYClamp&&(i=this.maxYClamp-s.getHeight()/2),this.tl.moveX(t-s.getWidth()/2),this.tl.moveY(i-s.getHeight()/2),this.tr.moveX(t+s.getWidth()/2),this.tr.moveY(i-s.getHeight()/2),this.bl.moveX(t-s.getWidth()/2),this.bl.moveY(i+s.getHeight()/2),this.br.moveX(t+s.getWidth()/2),this.br.moveY(i+s.getHeight()/2),e.setPosition(t,i)},i.prototype.dragCorner=function(i,e,s){var o,r=0,h=0,a=0,c=0,g=0,u=0,p=0,d=0,l=0;t.keepAspect?(o=s.getHorizontalNeighbour().getVerticalNeighbour(),a=o.getPosition().x,c=o.getPosition().y,o.getPosition().x>=i?o.getPosition().y>=e?(r=a-100/this.aspectRatio,h=c-100/this.aspectRatio*this.aspectRatio,l=this.getSide(n.instance.borrow(r,h),o.getPosition(),n.instance.borrow(i,e)),l>0?(g=Math.abs(o.getPosition().y-e),u=g/this.aspectRatio,p=o.getPosition().y-g,d=o.getPosition().x-u,s.move(d,p)):0>l&&(u=Math.abs(o.getPosition().x-i),g=u*this.aspectRatio,p=o.getPosition().y-g,d=o.getPosition().x-u,s.move(d,p))):(r=a-100/this.aspectRatio,h=c+100/this.aspectRatio*this.aspectRatio,l=this.getSide(n.instance.borrow(r,h),o.getPosition(),n.instance.borrow(i,e)),l>0?(u=Math.abs(o.getPosition().x-i),g=u*this.aspectRatio,p=o.getPosition().y+g,d=o.getPosition().x-u,s.move(d,p)):0>l&&(g=Math.abs(o.getPosition().y-e),u=g/this.aspectRatio,p=o.getPosition().y+g,d=o.getPosition().x-u,s.move(d,p))):o.getPosition().y>=e?(r=a+100/this.aspectRatio,h=c-100/this.aspectRatio*this.aspectRatio,l=this.getSide(n.instance.borrow(r,h),o.getPosition(),n.instance.borrow(i,e)),0>l?(g=Math.abs(o.getPosition().y-e),u=g/this.aspectRatio,p=o.getPosition().y-g,d=o.getPosition().x+u,s.move(d,p)):l>0&&(u=Math.abs(o.getPosition().x-i),g=u*this.aspectRatio,p=o.getPosition().y-g,d=o.getPosition().x+u,s.move(d,p))):(r=a+100/this.aspectRatio,h=c+100/this.aspectRatio*this.aspectRatio,l=this.getSide(n.instance.borrow(r,h),o.getPosition(),n.instance.borrow(i,e)),0>l?(u=Math.abs(o.getPosition().x-i),g=u*this.aspectRatio,p=o.getPosition().y+g,d=o.getPosition().x+u,s.move(d,p)):l>0&&(g=Math.abs(o.getPosition().y-e),u=g/this.aspectRatio,p=o.getPosition().y+g,d=o.getPosition().x+u,s.move(d,p)))):s.move(i,e),this.center.recalculatePosition(this.getBounds())},i.prototype.getSide=function(t,i,e){var s=this.sign((i.x-t.x)*(e.y-t.y)-(i.y-t.y)*(e.x-t.x));return n.instance.returnPoint(t),n.instance.returnPoint(e),s},i.prototype.sign=function(t){return+t===t?0===t?t:t>0?1:-1:0/0},i.prototype.handleRelease=function(t){if(null!=t){for(var i=0,e=0;this.currentDragTouches.length>e;e++)t.id==this.currentDragTouches[e].id&&(this.currentDragTouches[e].dragHandle.setDrag(!1),t.dragHandle=null,i=e);this.currentDragTouches.splice(i,1),this.draw(this.ctx)}},i.prototype.handleMove=function(t){for(var i=!1,e=0;this.currentDragTouches.length>e;e++)if(t.id==this.currentDragTouches[e].id&&null!=this.currentDragTouches[e].dragHandle){var s=this.currentDragTouches[e],o=this.clampPosition(t.x-s.dragHandle.offset.x,t.y-s.dragHandle.offset.y);t.x=o.x,t.y=o.y,n.instance.returnPoint(o),s.dragHandle instanceof a?this.dragCorner(t.x,t.y,s.dragHandle):this.dragCrop(t.x,t.y,s.dragHandle),i=!0;break}if(!i){for(var r=0;this.markers.length>r;r++){var h=this.markers[r];if(h.touchInBounds(t.x,t.y)){t.dragHandle=h,this.currentDragTouches.push(t),h.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCorner(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle);break}}null==t.dragHandle&&this.center.touchInBounds(t.x,t.y)&&(t.dragHandle=this.center,this.currentDragTouches.push(t),t.dragHandle.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.getPosition().x,t.dragHandle.offset.y=t.y-t.dragHandle.getPosition().y,this.dragCrop(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle))}},i.prototype.updateClampBounds=function(){var t=this.srcImage.height/this.srcImage.width,i=this.canvas.height/this.canvas.width,e=this.canvas.width,s=this.canvas.height;i>t?(e=this.canvas.width,s=this.canvas.width*t):(s=this.canvas.height,e=this.canvas.height/t),this.minXClamp=this.canvas.width/2-e/2,this.minYClamp=this.canvas.height/2-s/2,this.maxXClamp=this.canvas.width/2+e/2,this.maxYClamp=this.canvas.height/2+s/2},i.prototype.clampPosition=function(t,i){return this.minXClamp>t&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),this.minYClamp>i&&(i=this.minYClamp),i>this.maxYClamp&&(i=this.maxYClamp),n.instance.borrow(t,i)},i.prototype.isImageSet=function(){return this.imageSet},i.prototype.setImage=function(i){if(!i)throw"Image is null";this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var e=this.buffer.getContext("2d");e.clearRect(0,0,this.buffer.width,this.buffer.height);var s=i.src.split("."),o=s[1];("png"==o||"jpg"==o)&&(this.fileType=o),this.srcImage=i,this.updateClampBounds();var r=this.srcImage.height/this.srcImage.width,h=this.getBounds(),a=h.getHeight()/h.getWidth(),c=this.canvas.width,g=this.canvas.height;this.canvasWidth=c,this.canvasHeight=g;var u=this.canvas.width/2,p=this.canvas.height/2,d=n.instance.borrow(u-h.getWidth()/2,p+h.getHeight()/2),l=n.instance.borrow(u+h.getWidth()/2,p+h.getHeight()/2),v=n.instance.borrow(u-h.getWidth()/2,p-h.getHeight()/2),f=n.instance.borrow(u+h.getWidth()/2,p-h.getHeight()/2);if(this.tl.setPosition(d.x,d.y),this.tr.setPosition(l.x,l.y),this.bl.setPosition(v.x,v.y),this.br.setPosition(f.x,f.y),n.instance.returnPoint(d),n.instance.returnPoint(l),n.instance.returnPoint(v),n.instance.returnPoint(f),this.center.setPosition(u,p),a>r){var m=Math.min(c*r,g);if(h.getHeight()>m){var w=m/a;d=n.instance.borrow(u-w/2,p+m/2),l=n.instance.borrow(u+w/2,p+m/2),v=n.instance.borrow(u-w/2,p-m/2),f=n.instance.borrow(u+w/2,p-m/2),this.tl.setPosition(d.x,d.y),this.tr.setPosition(l.x,l.y),this.bl.setPosition(v.x,v.y),this.br.setPosition(f.x,f.y),n.instance.returnPoint(d),n.instance.returnPoint(l),n.instance.returnPoint(v),n.instance.returnPoint(f)}}else if(r>a){var y=Math.min(g/r,c);if(h.getWidth()>y){var b=y*a;d=n.instance.borrow(u-y/2,p+b/2),l=n.instance.borrow(u+y/2,p+b/2),v=n.instance.borrow(u-y/2,p-b/2),f=n.instance.borrow(u+y/2,p-b/2),this.tl.setPosition(d.x,d.y),this.tr.setPosition(l.x,l.y),this.bl.setPosition(v.x,v.y),this.br.setPosition(f.x,f.y),n.instance.returnPoint(d),n.instance.returnPoint(l),n.instance.returnPoint(v),n.instance.returnPoint(f)}}this.vertSquashRatio=this.detectVerticalSquash(i),this.draw(this.ctx);var x=this.getCroppedImage(t.cropWidth,t.cropHeight);this.publishCropData(),t.croppedImage=x.src},i.prototype.publishCropData=function(){var i=this.srcImage.height/this.srcImage.width,e=this.canvas.height/this.canvas.width,s=this.canvas.width,o=this.canvas.height;e>i?(s=this.canvas.width,o=this.canvas.width*i):i>e?(o=this.canvas.height,s=this.canvas.height/i):(o=this.canvas.height,s=this.canvas.width);var n=s/this.srcImage.width,r=o/this.srcImage.height,h=(this.buffer.width-s)/2,a=(this.buffer.height-o)/2;t.$emit("crop:done",{tl:[this.tl.position.x-h,this.tl.position.y-a],tr:[this.tr.position.x-h,this.tr.position.y-a],bl:[this.bl.position.x-h,this.bl.position.y-a],br:[this.br.position.x-h,this.br.position.y-a],cropWidth:Math.round(Math.abs(this.tr.position.x-this.tl.position.x)/n),cropHeight:Math.round(Math.abs(this.bl.position.y-this.tl.position.y)/r),srcWidth:this.srcImage.width,srcHeight:this.srcImage.height})},i.prototype.getCroppedImage=function(t,i){var e=this.getBounds();if(!this.srcImage)throw"Source image not set.";if(t&&i){var s=this.srcImage.height/this.srcImage.width,o=this.canvas.height/this.canvas.width,n=this.canvas.width,r=this.canvas.height;o>s?(n=this.canvas.width,r=this.canvas.width*s):s>o?(r=this.canvas.height,n=this.canvas.height/s):(r=this.canvas.height,n=this.canvas.width),this.ratioW=n/this.srcImage.width,this.ratioH=r/this.srcImage.height,this.cropCanvas.width=t,this.cropCanvas.height=i;var h=(this.buffer.height-r)/2/this.ratioH,a=(this.buffer.width-n)/2/this.ratioW,c=1,g=1;1>this.ratioW&&(c=this.ratioW),1>this.ratioH&&(g=this.ratioH),this.drawImageIOSFix(this.cropCanvas.getContext("2d"),this.srcImage,Math.max(Math.round(e.left/this.ratioW-a),0),Math.max(Math.round(e.top/this.ratioH-h),0),Math.max(Math.round(e.getWidth()/c),1),Math.max(Math.round(e.getHeight()/g),1),0,0,t,i),this.croppedImage.width=t,this.croppedImage.height=i}else this.cropCanvas.width=Math.max(e.getWidth(),1),this.cropCanvas.height=Math.max(e.getHeight(),1),this.cropCanvas.getContext("2d").drawImage(this.buffer,e.left,e.top,Math.max(e.getWidth(),1),Math.max(e.getHeight(),1),0,0,e.getWidth(),e.getHeight()),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height;return this.croppedImage.src=this.cropCanvas.toDataURL("image/"+this.fileType),this.croppedImage},i.prototype.getBounds=function(){for(var t=Number.MAX_VALUE,i=Number.MAX_VALUE,e=-Number.MAX_VALUE,s=-Number.MAX_VALUE,o=0;this.markers.length>o;o++){var n=this.markers[o];t>n.getPosition().x&&(t=n.getPosition().x),n.getPosition().x>e&&(e=n.getPosition().x),i>n.getPosition().y&&(i=n.getPosition().y),n.getPosition().y>s&&(s=n.getPosition().y)}var r=new c;return r.left=t,r.right=e,r.top=i,r.bottom=s,r},i.prototype.getMousePos=function(t,i){var e=t.getBoundingClientRect();return n.instance.borrow(i.clientX-e.left,i.clientY-e.top)},i.prototype.getTouchPos=function(t,i){var e=t.getBoundingClientRect();return n.instance.borrow(i.clientX-e.left,i.clientY-e.top)},i.prototype.onTouchMove=function(t){if(t.preventDefault(),t.touches.length>=1)for(var i=0;t.touches.length>i;i++){var e=t.touches[i],s=this.getTouchPos(this.canvas,e),o=new u(s.x,s.y,e.identifier);n.instance.returnPoint(s),this.move(o,t)}this.draw(this.ctx)},i.prototype.onMouseMove=function(t){var i=this.getMousePos(this.canvas,t);this.move(new u(i.x,i.y,0),t);var e=this.getDragTouchForID(0);e?(e.x=i.x,e.y=i.y):e=new u(i.x,i.y,0),n.instance.returnPoint(i),this.drawCursors(e,t),this.draw(this.ctx)},i.prototype.move=function(t){this.isMouseDown&&this.handleMove(t)},i.prototype.getDragTouchForID=function(t){for(var i=0;this.currentDragTouches.length>i;i++)if(t==this.currentDragTouches[i].id)return this.currentDragTouches[i]},i.prototype.drawCursors=function(t,i){var e=!1;null!=t&&(t.dragHandle==this.center&&(this.canvas.style.cursor="move",e=!0),null!=t.dragHandle&&t.dragHandle instanceof a&&(this.drawCornerCursor(t.dragHandle,t.dragHandle.getPosition().x,t.dragHandle.getPosition().y,i),e=!0));var s=!1;if(!e){for(var o=0;this.markers.length>o;o++)s=s||this.drawCornerCursor(this.markers[o],t.x,t.y,i);if(!s){var n=i.target;n.style.cursor="initial"}}s||e||!this.center.touchInBounds(t.x,t.y)?this.center.setOver(!1):(this.center.setOver(!0),this.canvas.style.cursor="move")},i.prototype.drawCornerCursor=function(t,i,e,s){var o;return t.touchInBounds(i,e)?(t.setOver(!0),t.getHorizontalNeighbour().getPosition().x>t.getPosition().x?t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(o=s.target,o.style.cursor="nwse-resize"):(o=s.target,o.style.cursor="nesw-resize"):t.getVerticalNeighbour().getPosition().y>t.getPosition().y?(o=s.target,o.style.cursor="nesw-resize"):(o=s.target,o.style.cursor="nwse-resize"),!0):(t.setOver(!1),!1)},i.prototype.onMouseDown=function(){this.isMouseDown=!0},i.prototype.onTouchStart=function(){this.isMouseDown=!0},i.prototype.onTouchEnd=function(i){for(var s=0;i.changedTouches.length>s;s++){var o=i.changedTouches[s],n=this.getDragTouchForID(o.identifier);null!=n&&((n.dragHandle instanceof a||n.dragHandle instanceof h)&&n.dragHandle.setOver(!1),this.handleRelease(n))}if(0==this.currentDragTouches.length&&(this.isMouseDown=!1),e.isImageSet()){var r=this.getCroppedImage(t.cropWidth,t.cropHeight);this.publishCropData(),t.croppedImage=r.src,t.$apply()}},i.prototype.onMouseUp=function(){this.handleRelease(new u(0,0,0)),0==this.currentDragTouches.length&&(this.isMouseDown=!1)},i.prototype.drawImageIOSFix=function(t,i,e,s,o,n,r,h,a,c){t.drawImage(i,e*this.vertSquashRatio,s*this.vertSquashRatio,o*this.vertSquashRatio,n*this.vertSquashRatio,r,h,a,c)},i.prototype.detectVerticalSquash=function(t){var i=(t.naturalWidth,t.naturalHeight),e=document.createElement("canvas");e.width=1,e.height=i;var s=e.getContext("2d");s.drawImage(t,0,0);for(var o=s.getImageData(0,0,1,i).data,n=0,r=i,h=i;h>n;){var a=o[4*(h-1)+3];0===a?r=h:n=h,h=r+n>>1}var c=h/i;return 0===c?1:c},i.prototype.onMouseDown=function(){this.isMouseDown=!0},i.prototype.onMouseUp=function(){if(e.isImageSet()){this.isMouseDown=!1,this.handleRelease(new u(0,0,0));var i=this.getCroppedImage(t.cropWidth,t.cropHeight);this.publishCropData(),t.croppedImage=i.src,t.$apply()}},i}();angular.element(document).ready(function(){var s=angular.element(i[0]),o=s[0],n=t.cropWidth,r=t.cropHeight,h=t.keepAspect,a=t.touchRadius;e=new p(o,o.width/2-n/2,o.height/2-r/2,n,r,h,a)}),t.$watch("image",function(i){if(null!=i){var s=new Image;s.addEventListener("load",function(){e.setImage(s);var i=e.getCroppedImage(t.cropWidth,t.cropHeight);e.publishCropData(),t.croppedImage=i.src,t.$apply()},!1),s.src=i}})}}}]),angular.module("angular-img-cropper").directive("imgCropperFileread",["$timeout",function(t){return{scope:{image:"="},link:function(i,e){e.bind("change",function(e){var s=new FileReader;s.onload=function(e){t(function(){i.image=e.target.result},0)},s.readAsDataURL(e.target.files[0])})}}}]);